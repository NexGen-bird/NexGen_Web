{% extends "base.html" %}

{% block title %}Dashboard - NEXGEN Study Centre{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="text-gradient-primary fw-bold mb-4">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </h1>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="row g-4 mb-5">
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon bg-success">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="metric-number text-success">{{ metrics.active_members }}</h3>
                    <p class="metric-label">Active Members</p>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon bg-warning">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h3 class="metric-number text-warning">{{ metrics.expired_subscriptions }}</h3>
                    <p class="metric-label">Expired Subscriptions</p>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon bg-primary">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="metric-number text-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ metrics.dash_pnl_amount_absolute }}">{{ metrics.current_month_pl }}</h3>
                    <p class="metric-label">Current Month P&L</p>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon bg-info">
                        <i class="fas fa-coins"></i>
                    </div>
                    <h3 class="metric-number text-info" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ metrics.dash_net_pnl_absolute }}">{{ metrics.net_pl }}</h3>
                    <p class="metric-label">Net P&L</p>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon bg-teal">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="metric-number text-teal" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ metrics.dash_collection_amount_absolute }}">{{ metrics.total_collection }}</h3>
                    <p class="metric-label">Total Collection</p>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon bg-danger">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <h3 class="metric-number text-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ metrics.dash_expense_amount_absolute }}">{{ metrics.total_expenses }}</h3>
                    <p class="metric-label">Total Expenses</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Shift Data Card -->
    <div class="row g-4 mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Shift Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for shift, value in shifts.items() %}
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="shift-item text-center">
                                <div class="shift-value">{{ value }}</div>
                                <div class="shift-label">{{ shift }}</div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Available Lockers Card -->
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="shift-item text-center clickable-locker" onclick="showLockerModal()">
                                <div class="shift-value">{{ available_lockers }}</div>
                                <div class="shift-label">Available Lockers</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Last 3 Months P&L Summary</h5>
                </div>
                <div class="card-body">
                    <canvas id="plChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Admission Summary (3 Months)</h5>
                </div>
                <div class="card-body">
                    <canvas id="admissionChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Expiring Subscriptions -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Expiring Subscriptions</h5>
                </div>
                <div class="card-body">
                    {% if expiring_subscriptions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Contact</th>
                                    <th>Expiry Date</th>
                                    <th>Plan</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in expiring_subscriptions %}
                                <tr>
                                    <td class="fw-semibold">
                                        <a href="javascript:void(0);" 
                                           onclick="showCustomerProfile('{{ customer.id }}')"
                                           class="text-decoration-none text-primary">
                                            {{ customer.name }}
                                        </a>
                                    </td>
                                    <td>{{ customer.phone_number }}</td>
                                    <td>
                                        <span class="badge" style="background-color: {{ customer.planexpirydate | bgcolor }}; color: white;">
                                            {{ customer.planexpirydate | format_date }}
                                        </span>
                                    </td>
                                    <td>{{ customer.plan }}</td>
                                    <td>
                                        <a href="{{ create_whatsapp_url(customer.phone_number, get_whatsapp_expiry_reminder(customer.name, customer.planexpirydate |format_date)) }}" 
                                           class="btn btn-whatsapp btn-sm" target="_blank">
                                            <i class="fab fa-whatsapp me-1"></i>WhatsApp
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                        <h5 class="text-muted">No subscriptions expiring in the next 7 days</h5>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Locker Information Modal -->
<div class="modal fade" id="lockerModal" tabindex="-1" aria-labelledby="lockerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="lockerModalLabel">
                    <i class="fas fa-key me-2"></i>Locker Assignment Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="lockerInfo">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading locker information...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Profile Modal -->
<div class="modal fade" id="customerProfileModal" tabindex="-1" aria-labelledby="customerProfileLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-gradient-primary text-white">
        <h5 class="modal-title" id="customerProfileLabel"><i class="fas fa-user me-2"></i>Customer Profile</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customerProfileContent">
        <div class="text-center">
          <div class="spinner-border text-info" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading profile...</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize dashboard charts
document.addEventListener('DOMContentLoaded', function() {
    // Fetch dashboard data
    fetch('/api/dashboard-data')
        .then(response => response.json())
        .then(data => {
            // P&L Chart
            const plCtx = document.getElementById('plChart').getContext('2d');
            new Chart(plCtx, {
                type: 'bar',
                data: {
                    labels: data.months_pnl,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: data.revenue_data,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Expenses',
                            data: data.expense_data,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Admission Chart
            const admissionCtx = document.getElementById('admissionChart').getContext('2d');
            new Chart(admissionCtx, {
                type: 'bar',
                data: {
                    labels: data.months_admission,
                    datasets: [{
                        label: 'New Admissions',
                        data: data.admission_data,
                        backgroundColor: 'rgba(79, 227, 120, 0.8)',
                        borderColor: 'rgba(79, 227, 120, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Re-Admissions',
                        data: data.readmission_data,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }
                ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading dashboard data:', error));
});

// Show locker modal and load data
function showLockerModal() {
    const modal = new bootstrap.Modal(document.getElementById('lockerModal'));
    modal.show();
    
    // Load locker data
    fetch('/api/lockers')
        .then(response => response.json())
        .then(data => {
            if (data.lockers && data.lockers.length > 0) {
            displayLockerInfo(data.lockers);
            } 
            else {
                document.getElementById('lockerInfo').innerHTML = '<div class="alert alert-danger">No Occupied Locker Available.</div>';
            }
        })
        .catch(error => {
            console.error('Error loading locker data:', error);
            document.getElementById('lockerInfo').innerHTML = '<div class="alert alert-danger">Error loading locker data</div>';
        });
}

function displayLockerInfo(lockers) {
    const container = document.getElementById('lockerInfo');
    let html = '<div class="table-responsive"><table class="table table-hover"><thead class="table-primary"><tr><th>Locker</th><th>Status</th><th>Customer</th><th>Contact</th><th>Expiry Date</th></tr></thead><tbody>';
    
    lockers.forEach(locker => {
        const statusClass = locker.status === 'Available' ? 'text-success' : 'text-danger';
        html += `<tr>
            <td><strong>${locker.number}</strong></td>
            <td><span class="badge bg-${locker.status === 'Available' ? 'success' : 'danger'}">${locker.status}</span></td>
            <td>${locker.customer || '-'}</td>
            <td>${locker.contact || '-'}</td>
            <td>${locker.assigned_date || '-'}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}
// Show customer profile modal
function showCustomerProfile(customerId) {
    const modal = new bootstrap.Modal(document.getElementById('customerProfileModal'));
    modal.show();

    fetch(`/api/customer/${customerId}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById("customerProfileContent");
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img src="${data.profile_image || '/static/images/default-profile.png'}" 
                             alt="Profile Picture" class="img-fluid rounded-circle mb-3" width="120">
                        <h5>${data.name}</h5>
                        <p class="text-muted">${data.plan}</p>
                    </div>
                    <div class="col-md-8">
                        <table class="table table-bordered">
                            <tr><th>Phone</th><td>${data.phone_number}</td></tr>
                            <tr><th>Email</th><td>${data.email || '-'}</td></tr>
                            <tr><th>Expiry</th><td>${data.planexpirydate}</td></tr>
                            <tr><th>Address</th><td>${data.address || '-'}</td></tr>
                        </table>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            document.getElementById("customerProfileContent").innerHTML =
                '<div class="alert alert-danger">Error loading profile</div>';
        });
}
</script>
{% endblock %}
    