{% extends "base.html" %}

{% block title %}Add Transaction - NEXGEN Study Centre{% endblock %}

{% block content %}
<!-- Information Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="infoModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Transaction Information
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <!-- <h6><i class="fas fa-lightbulb me-2"></i><strong>Incase of Investment:</strong> </h6>
                    <ul class="mb-0"> -->
                        <li><strong>incase of Investment:</strong><br> transaction type - 'IN'
                            <br> description - 'Investment'
                            <br> transaction made to - nexgen</li>
                        <li><strong>incase of Salary - </strong><br> transaction type - 'OUT'
                            <br> description - 'salary'
                           <br> transaction made to - abhijit shinde or jayesh thakre</li>
                        <!-- <li><strong>Investment:</strong> Partner Investment transactions</li>
                        <li><strong>Txn Type:</strong> IN for income, OUT for expenses</li>
                        <li><strong>Partial Payment:</strong> Note:
                        </li> -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-gradient-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add Transaction</h3>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="transactionForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="row g-3">
                            <!-- Customer Selection (if not pre-selected) -->
                            {% if not selected_customer %}
                            <div class="col-12" id="customer_name">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-user me-1 text-primary"></i>Select Customer *
                                </label>
                                <input type="text" 
                                       id="full_name" 
                                       name="full_name" 
                                       class="form-control"     
                                       autocomplete="off">
                            
                                <!-- Dropdown container -->
                                <div id="nameDropdown" 
                                     onclick="updateTxnType()"
                                     class="list-group position-absolute w-100 shadow-sm" 
                                     style="z-index: 1000; display: none;">
                                </div>
                            </div>
                            {% else %}
                            <div class="col-12">
                                <div class="alert alert-info" id="selected_customer_name">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Customer:</strong> {{ selected_customer.name }} - {{ selected_customer.phone_number }}
                                    <input type="hidden" name="customer_id" value="{{ selected_customer.id }}">
                                </div>
                            </div>
                            {% endif %}

                            <!-- Transaction Type -->
                            <div class="col-md-6">
                                <label for="{{ form.transaction_type.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-tag me-1 text-primary"></i>Transaction Mode *
                                </label>
                                {{ form.transaction_type(class="form-select", required=true, onchange="toggleFields()") }}
                            </div>

                            <!-- Transaction Date -->
                            <div class="col-md-6">
                                <label for="{{ form.transaction_date.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-calendar me-1 text-primary"></i>Transaction Date *
                                </label>
                                {{ form.transaction_date(class="form-control", required=true) }}
                            </div>

                            <!-- Plan -->
                            <div class="col-md-6">
                                <label for="{{ form.plan.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-clipboard-list me-1 text-primary"></i>Plan *
                                </label>
                                {{ form.plan(class="form-select", required=true, onchange="calculateEndDate()") }}
                            </div>

                            <!-- Shifts -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-clock me-1 text-primary"></i>Shifts *
                                </label>
                                <div class="border rounded p-3">
                                    {% for subfield in form.shifts %}
                                        <div class="form-check">
                                            {{ subfield(class="form-check-input") }}
                                            {{ subfield.label(class="form-check-label") }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Start Date -->
                            <div class="col-md-6">
                                <label for="{{ form.start_date.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-play-circle me-1 text-primary"></i>Start Date *
                                </label>
                                {{ form.start_date(class="form-control", required=true, onchange="calculateEndDate()") }}
                            </div>

                            <!-- End Date -->
                            <div class="col-md-6">
                                <label for="{{ form.end_date.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-stop-circle me-1 text-primary"></i>End Date *
                                </label>
                                {{ form.end_date(class="form-control", required=true) }}
                            </div>

                            <!-- Txn Type -->
                            <div class="col-md-6">
                                <label for="{{ form.txn_type.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-exchange-alt me-1 text-primary"></i>Txn Type
                                </label>
                                {{ form.txn_type(class="form-select", id="txn_type") }}
                            </div>

                            <!-- Locker Number -->
                            <div class="col-md-6">
                                <label for="{{ form.locker_number.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-key me-1 text-primary"></i>Locker Number
                                </label>
                                {{ form.locker_number(class="form-control") }}
                            </div>

                            <!-- Amount -->
                            <div class="col-md-12">
                                <label for="{{ form.amount.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-rupee-sign me-1 text-primary"></i>Amount *
                                </label>
                                {{ form.amount(class="form-control", required=true, step="1") }}
                            </div>

                            <!-- Payment Method -->
                            <div class="col-md-6">
                                <label for="{{ form.payment_method.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-credit-card me-1 text-primary"></i>Payment Method *
                                </label>
                                {{ form.payment_method(class="form-select", required=true, onchange="togglePartialPayment()") }}
                            </div>

                            <!-- Cash Amount (for partial payment) -->
                            <div class="col-md-3" id="cashAmountDiv" style="display: none;">
                                <label for="{{ form.cash_amount.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-money-bill me-1 text-primary"></i>Cash Amount
                                </label>
                                {{ form.cash_amount(class="form-control", step="1") }}
                            </div>

                            <!-- UPI Amount (for partial payment) -->
                            <div class="col-md-3" id="upiAmountDiv" style="display: none;">
                                <label for="{{ form.upi_amount.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-mobile-alt me-1 text-primary"></i>UPI Amount
                                </label>
                                {{ form.upi_amount(class="form-control", step="1") }}
                            </div>
                            <!-- Txn made by -->
                            <div class="col-md-6">
                                <label for="{{ form.txn_made_by.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-exchange-alt me-1 text-primary"></i>Transaction made by
                                </label>
                                {{ form.txn_made_by(class="form-control", id="txn_made_by") }}
                            </div>

                            <!-- Txn made to -->
                            <div class="col-md-6">
                                <label for="{{ form.txn_made_to.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-key me-1 text-primary"></i>Transaction made to
                                </label>
                                {{ form.txn_made_to(class="form-control", id="txn_made_to") }}
                            </div>
                            <!-- Description -->
                            <div class="col-12">
                                <label for="{{ form.description.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-comment me-1 text-primary"></i>Description
                                </label>
                                {{ form.description(class="form-control", rows="3", id="description") }}
                            </div>

                            <!-- Submit Button -->
                            <div class="col-12 text-center mt-4">
                                <button type="submit" class="btn btn-gradient-primary btn-lg px-5">
                                    <i class="fas fa-save me-2"></i>Save Transaction
                                </button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-lg px-4 ms-3">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateTxnType() {
    const transactionType = document.getElementById("transaction_type").value;
    const txnType = document.getElementById("txn_type");
    const txnmadeby = document.getElementById("txn_made_by");
    const txnmadeto = document.getElementById("txn_made_to");
    const customerSelect = document.querySelector('select[name="customer_id"]');
    const customerName = document.getElementById('full_name');
    const description = document.getElementById('description');
    const selectedName = document.getElementById('selected_customer_name')

    if (!txnType) return;

    if (transactionType === "General") {
        txnType.value = "OUT";   // Set to OUT
        txnmadeby.value = "nexgen";
        customerName.removeAttribute('required','required');
    } else if (transactionType === "Admission") {
        const username = "{{ session.get('userName', '') }}";
        txnmadeby.value = customerName.value;
        customerName.setAttribute('required','required');
        txnType.value = "IN";    // Set to IN
        txnmadeto.value = username.toLowerCase();    // Set to logged in user
        description.value = "admission";
       
    }
    else if (transactionType === "Investment") {
        const username = "{{ session.get('userName', '') }}";
        txnType.value = "IN";    // Set to IN
        txnmadeby.value = username.toLowerCase();    // Set to logged in user
        txnmadeto.value = "nexgen";    
        description.value = "investment";
        customerName.removeAttribute('required','required');
       
    }
    if (txnType.value === "OUT"){
        txnmadeby.value = "nexgen";
    } 
    
}

function toggleFields() {
    const transactionType = document.getElementById('transaction_type').value;
    const planField = document.getElementById('plan');
    const customerName = document.getElementById('customer_name');
    const customerNameinput = document.getElementById('full_name');
    const shiftsDiv = document.querySelector('.col-md-6:has(.border)');
    const startDateField = document.getElementById('start_date');
    const endDateField = document.getElementById('end_date');
    const customerSelect = document.querySelector('select[name="customer_id"]');
    
    if (transactionType != 'Admission') {
        // Hide customer-related fields for Investment
        if (customerSelect) customerSelect.closest('.col-12').style.display = 'none';
        planField.closest('.col-md-6').style.display = 'none';
        customerName.closest('.col-12').style.display = 'none';
        customerNameinput.removeAttribute('required','required');
        shiftsDiv.style.display = 'none';
        startDateField.closest('.col-md-6').style.display = 'none';
        endDateField.closest('.col-md-6').style.display = 'none';
        document.getElementById('locker_number').closest('.col-md-6').style.display = 'none';
    } else {
        // Show fields for admission/General
        if (customerSelect) customerSelect.closest('.col-12').style.display = 'block';
        customerName.closest('.col-12').style.display = 'block';
        planField.closest('.col-md-6').style.display = 'block';
        customerNameinput.setAttribute('required','required');
    
        shiftsDiv.style.display = 'block';
        startDateField.closest('.col-md-6').style.display = 'block';
        endDateField.closest('.col-md-6').style.display = 'block';
        document.getElementById('locker_number').closest('.col-md-6').style.display = 'block';
    }
    // Always update txn_type when transaction_type changes
    updateTxnType();
}

function togglePartialPayment() {
    const paymentMethod = document.getElementById('payment_method').value;
    const cashDiv = document.getElementById('cashAmountDiv');
    const upiDiv = document.getElementById('upiAmountDiv');
    
    if (paymentMethod === 'Partial') {
        cashDiv.style.display = 'block';
        upiDiv.style.display = 'block';
    } else {
        cashDiv.style.display = 'none';
        upiDiv.style.display = 'none';
    }
}

function calculateEndDate() {
    const startDate = document.getElementById('start_date').value;
    const plan = document.getElementById('plan').value;
    
    if (startDate && plan) {
        const start = new Date(startDate);
        let end = new Date(start);
        console.log(plan)
        switch(plan) {
            case '2':
                end.setMonth(end.getMonth() + 1);
                break;
            case '3':
                end.setMonth(end.getMonth() + 3);
                break;
            case '4':
                end.setMonth(end.getMonth() + 6);
                break;
            case '5':
                end.setFullYear(end.getFullYear() + 1);
                break;
            case '1':
                end.setDate(end.getDate() + 1);
                break;
            case '6':
                end.setMonth(end.getMonth() + 1);
                break;
        }
        // Always subtract 1 day
        end.setDate(end.getDate() - 1);
        document.getElementById('end_date').value = end.toISOString().split('T')[0];
    }
}

// Initialize page on load
document.addEventListener('DOMContentLoaded', function() {
    // Show info modal on page load
    const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    infoModal.show();
    
    calculateEndDate();
    toggleFields();
    togglePartialPayment();
    updateTxnType();
});
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("full_name");
        const dropdown = document.getElementById("nameDropdown");
    
        input.addEventListener("input", function () {
            let query = input.value.trim();
            if (query.length < 2) {
                dropdown.style.display = "none";
                return;
            }
    
            fetch(`/autocomplete/txnnames?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    dropdown.innerHTML = "";
                    if (data.length > 0) {
                        data.forEach(name => {
                            let item = document.createElement("a");
                            item.classList.add("list-group-item", "list-group-item-action");
                            item.textContent = name;
                            item.addEventListener("click", function () {
                                input.value = name;
                                dropdown.style.display = "none";
                            });
                            dropdown.appendChild(item);
                        });
                        dropdown.style.display = "block";
                    } else {
                        dropdown.style.display = "none";
                    }
                });
        });
    
        // Hide dropdown if clicked outside
        document.addEventListener("click", function (e) {
            if (!dropdown.contains(e.target) && e.target !== input) {
                dropdown.style.display = "none";
            }
        });
    });
    </script>

{% endblock %}
