{% extends "base.html" %}

{% block title %}Add Transaction - NEXGEN Study Centre{% endblock %}

{% block content %}
<!-- Information Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="infoModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Transaction Information
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-lightbulb me-2"></i>Quick Guide:</h6>
                    <ul class="mb-0">
                        <li><strong>General:</strong> Regular membership transactions</li>
                        <li><strong>Admission:</strong> New student enrollments</li>
                        <li><strong>Investment:</strong> Partner investment transactions</li>
                        <li><strong>Txn Type:</strong> IN for income, OUT for expenses</li>
                        <li><strong>Partial Payment:</strong> Split between Cash and UPI amounts</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-gradient-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add Transaction</h3>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="transactionForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="row g-3">
                            <!-- Customer Selection (if not pre-selected) -->
                            {% if not selected_customer %}
                            <div class="col-12">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-user me-1 text-primary"></i>Select Customer *
                                </label>
                                <select name="customer_id" class="form-select" required>
                                    <option value="">Choose a customer...</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.full_name }} - {{ customer.contact_number }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% else %}
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Customer:</strong> {{ selected_customer.full_name }} ({{ selected_customer.contact_number }})
                                    <input type="hidden" name="customer_id" value="{{ selected_customer.id }}">
                                </div>
                            </div>
                            {% endif %}

                            <!-- Transaction Type -->
                            <div class="col-md-6">
                                <label for="{{ form.transaction_type.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-tag me-1 text-primary"></i>Transaction Type *
                                </label>
                                {{ form.transaction_type(class="form-select", required=true, onchange="toggleFields()") }}
                            </div>

                            <!-- Transaction Date -->
                            <div class="col-md-6">
                                <label for="{{ form.transaction_date.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-calendar me-1 text-primary"></i>Transaction Date *
                                </label>
                                {{ form.transaction_date(class="form-control", required=true) }}
                            </div>

                            <!-- Plan -->
                            <div class="col-md-6">
                                <label for="{{ form.plan.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-clipboard-list me-1 text-primary"></i>Plan *
                                </label>
                                {{ form.plan(class="form-select", required=true, onchange="calculateEndDate()") }}
                            </div>

                            <!-- Shifts -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-clock me-1 text-primary"></i>Shifts *
                                </label>
                                <div class="border rounded p-3">
                                    {% for subfield in form.shifts %}
                                        <div class="form-check">
                                            {{ subfield(class="form-check-input") }}
                                            {{ subfield.label(class="form-check-label") }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Start Date -->
                            <div class="col-md-6">
                                <label for="{{ form.start_date.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-play-circle me-1 text-primary"></i>Start Date *
                                </label>
                                {{ form.start_date(class="form-control", required=true, onchange="calculateEndDate()") }}
                            </div>

                            <!-- End Date -->
                            <div class="col-md-6">
                                <label for="{{ form.end_date.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-stop-circle me-1 text-primary"></i>End Date *
                                </label>
                                {{ form.end_date(class="form-control", required=true) }}
                            </div>

                            <!-- Txn Type -->
                            <div class="col-md-6">
                                <label for="{{ form.txn_type.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-exchange-alt me-1 text-primary"></i>Txn Type
                                </label>
                                {{ form.txn_type(class="form-select") }}
                            </div>

                            <!-- Locker Number -->
                            <div class="col-md-6">
                                <label for="{{ form.locker_number.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-key me-1 text-primary"></i>Locker Number
                                </label>
                                {{ form.locker_number(class="form-control") }}
                            </div>

                            <!-- Amount -->
                            <div class="col-md-12">
                                <label for="{{ form.amount.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-rupee-sign me-1 text-primary"></i>Amount *
                                </label>
                                {{ form.amount(class="form-control", required=true, step="0.01") }}
                            </div>

                            <!-- Payment Method -->
                            <div class="col-md-6">
                                <label for="{{ form.payment_method.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-credit-card me-1 text-primary"></i>Payment Method *
                                </label>
                                {{ form.payment_method(class="form-select", required=true, onchange="togglePartialPayment()") }}
                            </div>

                            <!-- Cash Amount (for partial payment) -->
                            <div class="col-md-3" id="cashAmountDiv" style="display: none;">
                                <label for="{{ form.cash_amount.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-money-bill me-1 text-primary"></i>Cash Amount
                                </label>
                                {{ form.cash_amount(class="form-control", step="0.01") }}
                            </div>

                            <!-- UPI Amount (for partial payment) -->
                            <div class="col-md-3" id="upiAmountDiv" style="display: none;">
                                <label for="{{ form.upi_amount.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-mobile-alt me-1 text-primary"></i>UPI Amount
                                </label>
                                {{ form.upi_amount(class="form-control", step="0.01") }}
                            </div>

                            <!-- Description -->
                            <div class="col-12">
                                <label for="{{ form.description.id }}" class="form-label fw-semibold">
                                    <i class="fas fa-comment me-1 text-primary"></i>Description
                                </label>
                                {{ form.description(class="form-control", rows="3") }}
                            </div>

                            <!-- Submit Button -->
                            <div class="col-12 text-center mt-4">
                                <button type="submit" class="btn btn-gradient-primary btn-lg px-5">
                                    <i class="fas fa-save me-2"></i>Save Transaction
                                </button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-lg px-4 ms-3">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleFields() {
    const transactionType = document.getElementById('transaction_type').value;
    const planField = document.getElementById('plan');
    const shiftsDiv = document.querySelector('.col-md-6:has(.border)');
    const startDateField = document.getElementById('start_date');
    const endDateField = document.getElementById('end_date');
    const customerSelect = document.querySelector('select[name="customer_id"]');
    
    if (transactionType === 'investment') {
        // Hide customer-related fields for investment
        if (customerSelect) customerSelect.closest('.col-12').style.display = 'none';
        planField.closest('.col-md-6').style.display = 'none';
        shiftsDiv.style.display = 'none';
        startDateField.closest('.col-md-6').style.display = 'none';
        endDateField.closest('.col-md-6').style.display = 'none';
        document.getElementById('locker_number').closest('.col-md-6').style.display = 'none';
    } else {
        // Show fields for admission/general
        if (customerSelect) customerSelect.closest('.col-12').style.display = 'block';
        planField.closest('.col-md-6').style.display = 'block';
        shiftsDiv.style.display = 'block';
        startDateField.closest('.col-md-6').style.display = 'block';
        endDateField.closest('.col-md-6').style.display = 'block';
        document.getElementById('locker_number').closest('.col-md-6').style.display = 'block';
    }
}

function togglePartialPayment() {
    const paymentMethod = document.getElementById('payment_method').value;
    const cashDiv = document.getElementById('cashAmountDiv');
    const upiDiv = document.getElementById('upiAmountDiv');
    
    if (paymentMethod === 'Partial') {
        cashDiv.style.display = 'block';
        upiDiv.style.display = 'block';
    } else {
        cashDiv.style.display = 'none';
        upiDiv.style.display = 'none';
    }
}

function calculateEndDate() {
    const startDate = document.getElementById('start_date').value;
    const plan = document.getElementById('plan').value;
    
    if (startDate && plan) {
        const start = new Date(startDate);
        let end = new Date(start);
        
        switch(plan) {
            case 'Monthly':
                end.setMonth(end.getMonth() + 1);
                break;
            case 'Quarterly':
                end.setMonth(end.getMonth() + 3);
                break;
            case 'Half Yearly':
                end.setMonth(end.getMonth() + 6);
                break;
            case 'Yearly':
                end.setFullYear(end.getFullYear() + 1);
                break;
            case 'Day':
                end.setDate(end.getDate() + 1);
                break;
            case 'Weekend':
                end.setDate(end.getDate() + 2);
                break;
        }
        
        document.getElementById('end_date').value = end.toISOString().split('T')[0];
    }
}

// Initialize page on load
document.addEventListener('DOMContentLoaded', function() {
    // Show info modal on page load
    const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    infoModal.show();
    
    calculateEndDate();
    toggleFields();
    togglePartialPayment();
});
</script>
{% endblock %}
