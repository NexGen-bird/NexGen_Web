{% extends "base.html" %}

{% block title %}Receipt - NEXGEN Study Centre{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Action Buttons -->
            <div class="text-center mb-4 no-print">
                <div class="btn-group" role="group">
                    <button onclick="window.print()" class="btn btn-gradient-primary">
                        <i class="fas fa-print me-2"></i>Print Receipt
                    </button>
                    <a href="{{ whatsapp_url }}" class="btn btn-whatsapp" target="_blank">
                        <i class="fab fa-whatsapp me-2"></i>Share via WhatsApp
                    </a>
                    <a href="{{ url_for('transactions') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Transactions
                    </a>
                </div>
            </div>

            <!-- Receipt -->
            <div class="card border-0 shadow-lg receipt-container">
                <div class="card-body p-5">
                    <!-- Header -->
                    <div class="text-center mb-4">
                        <img src="{{ url_for('static', filename='images/nexgen-logo.svg') }}" alt="NEXGEN" height="60" class="mb-3">
                        <h2 class="text-gradient-primary fw-bold">NEXGEN Study Centre</h2>
                        <p class="text-muted mb-1">Your Gateway to Success</p>
                        <hr class="my-4">
                    </div>

                    <!-- Receipt Header -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4 class="text-primary fw-bold">PAYMENT RECEIPT</h4>
                            <p class="text-muted">Receipt #{{ transaction.id }}</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <p class="mb-1"><strong>Date:</strong> {{ transaction.transaction_date.strftime('%d/%m/%Y') }}</p>
                            <p class="mb-1"><strong>Payment Method:</strong> {{ transaction.payment_method }}</p>
                            <p class="mb-0"><strong>Transaction Type:</strong> 
                                <span class="badge bg-{{ 'primary' if transaction.transaction_type == 'admission' else 'info' }}">
                                    {{ transaction.transaction_type.title() }}
                                </span>
                            </p>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <h5 class="card-title text-primary mb-3">
                                        <i class="fas fa-user me-2"></i>Customer Information
                                    </h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Name:</strong> {{ customer.full_name }}</p>
                                            <p class="mb-1"><strong>Contact:</strong> {{ customer.contact_number }}</p>
                                            <p class="mb-0"><strong>Email:</strong> {{ customer.email }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Age:</strong> {{ customer.age }} years</p>
                                            <p class="mb-1"><strong>Study Option:</strong> {{ customer.study_option }}</p>
                                            <p class="mb-0"><strong>Gender:</strong> {{ customer.gender }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Details -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-receipt me-2"></i>Transaction Details
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Description</th>
                                            <th>Plan</th>
                                            <th>Duration</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <strong>{{ transaction.transaction_type.title() }} Fee</strong>
                                                {% if transaction.shifts %}
                                                    {% set shifts = transaction.shifts | from_json %}
                                                    <br><small class="text-muted">Shifts: {{ shifts | join(', ') }}</small>
                                                {% endif %}
                                                {% if transaction.locker_number %}
                                                    <br><small class="text-muted">Locker: {{ transaction.locker_number }}</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ transaction.plan }}</td>
                                            <td>
                                                {{ transaction.start_date.strftime('%d/%m/%Y') }} to<br>
                                                {{ transaction.end_date.strftime('%d/%m/%Y') }}
                                            </td>
                                            <td>{{ format_currency(transaction.amount) }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6 offset-md-6">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">Payment Summary</h5>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span>{{ format_currency(transaction.amount) }}</span>
                                    </div>
                                    {% if transaction.discount > 0 %}
                                    <div class="d-flex justify-content-between mb-2 text-success">
                                        <span>Discount:</span>
                                        <span>-{{ format_currency(transaction.discount) }}</span>
                                    </div>
                                    {% endif %}
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold text-primary">
                                        <span>Total Paid:</span>
                                        <span>{{ format_currency(transaction.final_amount) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subscription Details -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-success border-0">
                                <h5 class="alert-heading">
                                    <i class="fas fa-check-circle me-2"></i>Subscription Active
                                </h5>
                                <p class="mb-0">
                                    Your subscription is active from <strong>{{ transaction.start_date.strftime('%d/%m/%Y') }}</strong> 
                                    to <strong>{{ transaction.end_date.strftime('%d/%m/%Y') }}</strong>
                                </p>
                                {% if transaction.is_regular %}
                                <p class="mb-0 mt-2">
                                    <i class="fas fa-star text-warning me-1"></i>
                                    <strong>Regular Student Benefits Applied</strong>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="text-center mt-5 pt-4 border-top">
                        <p class="text-muted mb-2">Thank you for choosing NEXGEN Study Centre!</p>
                        <p class="text-muted small mb-0">
                            For any queries, please contact us or visit our center.<br>
                            This is a computer-generated receipt.
                        </p>
                        
                        <!-- WhatsApp Share Button (Print Version) -->
                        <div class="mt-3 print-only">
                            <p class="small text-muted">
                                Share this receipt: <strong>{{ whatsapp_url }}</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
@media print {
    .no-print {
        display: none !important;
    }
    
    .receipt-container {
        box-shadow: none !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .card-body {
        padding: 2rem !important;
    }
    
    .print-only {
        display: block !important;
    }
    
    .alert {
        border: 1px solid #d1ecf1 !important;
        background-color: #d1ecf1 !important;
    }
}

.print-only {
    display: none;
}

.receipt-container {
    background: white;
}

.table-primary {
    background-color: var(--bs-primary) !important;
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-focus print dialog after page loads (optional)
// window.addEventListener('load', function() {
//     // Uncomment the line below to auto-print when page loads
//     // window.print();
// });

// Handle WhatsApp share with custom message
function shareViaWhatsApp() {
    const message = `Receipt from NEXGEN Study Centre
    
Customer: {{ customer.full_name }}
Amount Paid: {{ format_currency(transaction.final_amount) }}
Plan: {{ transaction.plan }}
Valid From: {{ transaction.start_date.strftime('%d/%m/%Y') }}
Valid Till: {{ transaction.end_date.strftime('%d/%m/%Y') }}

Thank you for choosing NEXGEN Study Centre! 🎓`;

    const url = `https://wa.me/{{ customer.contact_number.replace('+', '').replace(' ', '') }}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}
